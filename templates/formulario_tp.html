<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario TP - Evaluación Docente</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .form-section { margin-bottom: 2em; }
    .pregunta { border: 1px solid #ccc; padding: 1em; margin-bottom: 1em; }
    .campo { margin-bottom: 0.5em; }
    label { font-weight: bold; display: block; margin-bottom: 0.3em; }
    select, input[type="text"], input[type="date"] { width: 100%; padding: 0.4em; }
    .resultado-final { font-weight: bold; font-size: 1.2em; }
    .hidden { display: none; }
    .btn-green { background-color: green; color: white; padding: 0.6em 1.2em; border: none; cursor: pointer; }
    .btn-group { display: flex; justify-content: end; margin-top: 1em; }
  </style>
</head>
<body>
<div class="container">
  <h2>Evaluación del desempeño en el aula - TP</h2>
  <form id="formulario-tp">
    <div class="form-section" id="preguntas-aula"></div>

    <div class="form-section">
      <label>Total Puntaje:</label>
      <input type="text" id="total-puntaje" readonly>
      <label>Porcentaje:</label>
      <input type="text" id="porcentaje" readonly>
      <label>Resultado:</label>
      <input type="text" id="resultado-final" class="resultado-final" readonly>
    </div>

    <button type="button" onclick="mostrarSegundaSeccion()">Continuar con la Evaluación de la carpeta pedagógica – TP</button>

    <div class="form-section hidden" id="seccion-carpetas">
      <h2>Evaluación de la carpeta pedagógica – TP</h2>
      <div id="preguntas-carpetas"></div>

      <div class="form-section">
        <label>Porcentaje:</label>
        <input type="text" id="porcentaje-carpetas" readonly>
        <label>Resultado:</label>
        <input type="text" id="resultado-carpetas" class="resultado-final" readonly>
      </div>

      <div class="form-section">
        <label>Fecha de Evaluación:</label>
        <input type="date" id="fecha-evaluacion">
      </div>

      <div class="btn-group">
         <button type="button" id="btn-enviar" class="btn-green">ENVIAR</button>
      </div>
    </div>
  </form>
</div>

<script>
// Preguntas de aula
const preguntasAula = [
  ["Comparte de forma explícita...", 2],
  ["Comparte dos o más ejemplos...", 2],
  ["Comunica puntos clave...", 1],
  ["Explica temas con recursos...", 2],
  ["Explica procedimiento práctico...", 2],
  ["Realiza preguntas abiertas...", 3],
  ["Logra participación activa...", 3],
  ["Actividad en parejas/equipo...", 3],
  ["Emplea recursos TIC...", 1],
  ["Monitorea trabajo estudiantil...", 2],
  ["Retroalimenta participación...", 3],
  ["Refuerza positivamente...", 1]
];

const containerAula = document.getElementById("preguntas-aula");
preguntasAula.forEach((pregunta, i) => {
  const index = i + 1;
  const peso = pregunta[1];
  const div = document.createElement("div");
  div.className = "pregunta";
  div.innerHTML = `
    <div class="campo"><label>Pregunta ${index}</label><p>${pregunta[0]}</p></div>
    <div class="campo"><label>Peso:</label><input type="text" value="${peso}" readonly></div>
    <div class="campo">
      <label>Valoración:</label>
      <select name="valoracion" class="valoracion-aula">
        <option value="">Seleccione</option>
        <option>Se observa</option>
        <option>Se observa parcialmente</option>
        <option>No se observa</option>
      </select>
    </div>
    <div class="campo">
      <label>Puntaje:</label>
      <input type="text" class="puntaje" readonly>
    </div>
    <div class="campo"><label>Observaciones:</label><input type="text" class="obs-aula"></div>
    <div class="campo"><label>Recomendaciones:</label><input type="text" class="rec-aula"></div>
  `;
  containerAula.appendChild(div);
});

// Eventos para aula
document.querySelectorAll(".valoracion-aula").forEach(select => {
  select.addEventListener("change", () => {
    const valoracion = select.value;
    const peso = parseFloat(select.closest(".pregunta").querySelector("input[type='text']").value);
    let puntaje = 0;
    if (valoracion === "Se observa") puntaje = peso;
    else if (valoracion === "Se observa parcialmente") puntaje = peso * 0.5;
    select.closest(".pregunta").querySelector(".puntaje").value = puntaje;
    calcularResultados();
  });
});

function calcularResultados() {
  let total = 0;
  document.querySelectorAll(".puntaje").forEach(s => {
    const val = parseFloat(s.value);
    if (!isNaN(val)) total += val;
  });
  const porcentaje = (total / 25 * 100).toFixed(2);
  document.getElementById("total-puntaje").value = total;
  document.getElementById("porcentaje").value = porcentaje + "%";
  const resultado = document.getElementById("resultado-final");
  if (porcentaje >= 90) resultado.value = "DESTACADO";
  else if (porcentaje >= 75) resultado.value = "LOGRADO";
  else if (porcentaje >= 50) resultado.value = "EN PROCESO";
  else if (porcentaje > 0) resultado.value = "EN INICIO";
  else resultado.value = "";
}

function mostrarSegundaSeccion() {
  document.getElementById("seccion-carpetas").classList.remove("hidden");
}

// Preguntas de carpeta
const preguntasCarpeta = [
  "¿La versión del sílabo es la correcta?",
  "¿Los datos del sílabo están actualizados?",
  "¿El plan de clase está alineado con la sesión observada?",
  "¿La asignación de fechas está actualizada?",
  "¿Los planes de clase están cargados?",
  "¿Las PPT y recursos están alineados?",
  "¿Se cuenta con el registro de asistencia?",
  "¿Se cuenta con el registro de evaluaciones?"
];

const containerCarpeta = document.getElementById("preguntas-carpetas");
preguntasCarpeta.forEach((pregunta, i) => {
  const index = i + 1;
  const div = document.createElement("div");
  div.className = "pregunta";
  div.innerHTML = `
    <div class="campo"><label>Pregunta ${index}</label><p>${pregunta}</p></div>
    <div class="campo"><label>Peso:</label><input type="text" value="12.5" readonly></div>
    <div class="campo">
      <label>Valoración:</label>
      <select class="valoracion-carpetas">
        <option value="">Seleccione</option>
        <option>Se observa</option>
        <option>Se observa parcialmente</option>
        <option>No se observa</option>
      </select>
    </div>
    <div class="campo"><label>Observaciones:</label><input type="text" class="obs-car"></div>
    <div class="campo"><label>Recomendaciones:</label><input type="text" class="rec-car"></div>
  `;
  containerCarpeta.appendChild(div);
});

// Eventos para carpeta
document.querySelectorAll(".valoracion-carpetas").forEach(select => {
  select.addEventListener("change", () => {
    calcularResultadosCarpeta();
  });
});
  
function calcularResultadosCarpeta() {
  let totalCarpeta = 0;

  document.querySelectorAll(".valoracion-carpetas").forEach(s => {
    const valoracion = s.value;
    const peso = 12.5;
    let puntaje = 0;

    if (valoracion === "Se observa") puntaje = peso;
    else if (valoracion === "Se observa parcialmente") puntaje = peso * 0.5;
    totalCarpeta += puntaje;
  });

  const porcentajeCarpeta = totalCarpeta.toFixed(2);
  document.getElementById("porcentaje-carpetas").value = porcentajeCarpeta + "%";

  const resultadoCarpeta = document.getElementById("resultado-carpetas");
  if (porcentajeCarpeta >= 90) resultadoCarpeta.value = "DESTACADO";
  else if (porcentajeCarpeta >= 75) resultadoCarpeta.value = "LOGRADO";
  else if (porcentajeCarpeta >= 50) resultadoCarpeta.value = "EN PROCESO";
  else if (porcentajeCarpeta > 0) resultadoCarpeta.value = "EN INICIO";
  else resultadoCarpeta.value = "";

  return porcentajeCarpeta;
}

// Enviar formulario
document.getElementById("btn-enviar").addEventListener("click", async () => {
  // Recalcular resultados antes de enviar
  calcularResultados();
  const porcentajeCarpeta = calcularResultadosCarpeta();

  const respuestasAula = [];
  document.querySelectorAll("#preguntas-aula .pregunta").forEach(p => {
    respuestasAula.push({
      valoracion: p.querySelector(".valoracion-aula")?.value || "",
      puntaje: p.querySelector(".puntaje")?.value || "",
      observaciones: p.querySelector(".obs-aula")?.value || "",
      recomendaciones: p.querySelector(".rec-aula")?.value || ""
    });
  });

  const respuestasCarpeta = [];
  document.querySelectorAll("#preguntas-carpetas .pregunta").forEach(p => {
    respuestasCarpeta.push({
      valoracion: p.querySelector(".valoracion-carpetas")?.value || "",
      observaciones: p.querySelector(".obs-car")?.value || "",
      recomendaciones: p.querySelector(".rec-car")?.value || ""
    });
  });

  const resultadoAula = document.getElementById("resultado-final").value || "";
  const resultadoCarpeta = document.getElementById("resultado-carpetas").value || "";
  const fechaRegistro = new Date().toISOString().split('T')[0];
  const fechaEvaluacion = document.getElementById("fecha-evaluacion").value || fechaRegistro;

  const payload = {
    ANO: sessionStorage.getItem("ano"),
    PERIODO: sessionStorage.getItem("periodo"),
    SEDE_CURSO: sessionStorage.getItem("sede_curso"),
    Carrera: sessionStorage.getItem("carrera"),
    Seccion: sessionStorage.getItem("seccion"),
    Asignatura: sessionStorage.getItem("asignatura"),
    INSTRUCTOR: sessionStorage.getItem("instructor"),
    NRC: sessionStorage.getItem("nrc"),
    Eval_Aula: document.getElementById("porcentaje").value,
    Resultado_Aula: resultadoAula,
    Eval_Carpeta: porcentajeCarpeta + "%",
    Resultado_Carpeta: resultadoCarpeta,
    respuestasAula,
    respuestasCarpeta,
    fechaRegistro,
    fechaEvaluacion
  };

  try {
    const response = await fetch("/guardar_resultado_tp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (result.status === "ok") {
      alert("Evaluación guardada exitosamente.");
      window.location.href = "/";
    } else {
      alert("Error al guardar la evaluación: " + result.mensaje);
    }
  } catch (error) {
    alert("Error de conexión al guardar la evaluación.");
    console.error(error);
  }
});


